<html lang="en" class="terria">
<head>
    <base href="/">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">  <!-- Use Chrome Frame in IE -->
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta name="description" content="A web map built on Terria Map">
    <meta name="copyright" content="Copyright(c) 2012-2016 National ICT Australia Limited (NICTA), CSIRO Data61.  All rights reserved.">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <link rel="apple-touch-icon" sizes="57x57" href="favicons/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="favicons/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="favicons/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="favicons/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="favicons/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="favicons/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="favicons/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="favicons/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="favicons/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="favicons/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="favicons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicons/favicon-16x16.png">
    <link rel="manifest" href="favicons/manifest.json">
    <meta name="msapplication-TileColor" content="#282D32">
    <meta name="msapplication-TileImage" content="favicons/ms-icon-144x144.png">
    <meta name="theme-color" content="#282D32">

    <title>Terria Map</title>

    <!-- Leaflet -->
    <script>L_PREFER_CANVAS = true;</script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.104/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
      .TerriaLogo___StyledImg-sc-bk2yek-0 {
    display: none !important;
}
.guidelines-button {
    position: fixed;
    bottom: 20px;
    right: 90px; /* Shift left from Chat avatar */
    width: 50px;
    height: 50px;
    background-color: white;
    border-radius: 50%;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1000;
    position: fixed;
}

.guidelines-button:hover .guidelines-tooltip {
    display: block;
}

.guidelines-tooltip {
    display: none;
    position: absolute;
    bottom: 60px;
    right: 0;
    background: white;
    border: 1px solid #ccc;
    padding: 5px;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    z-index: 1001;
}

.guidelines-tooltip img {
    max-width: 500px;
    max-height: 700px;
    border-radius: 10px;
}


.chatbox-avatar {
    display: flex;
    justify-content: center; /* Centers horizontally */
    align-items: center; /* Centers vertically if needed */
    padding: 10px 0; /* Adds some spacing */
}

.chatbox-avatar img {
    width: 50px; /* Adjust if needed */
    height: 50px;
    border-radius: 50%; /* Makes it round */
}


        /* Floating avatar button */
        .floating-button {
          position: fixed;
          bottom: 20px;
          right: 20px;
          width: 50px;
          height: 50px;
          background-color: white;
          border-radius: 50%;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          z-index: 1000;
        }
      
        .avatar {
          width: 50px;
          height: 50px;
          border-radius: 50%;
        }
      
        .floating-button:hover {
          box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
          transform: scale(1.05);
          transition: all 0.2s ease;
        }
      
        /* Chatbox modal */
        .chatbox-modal {
    display: none;
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 600px;
    background-color: #ffffff;
    border-radius: 15px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    z-index: 1001;
    transition: all 0.3s ease;
}

.chatbox-modal.show {
    display: block !important; /* üî• Force visibility */
}
      
        .chatbox-header {
          padding: 10px;
          background-color: #5A67D8;
          color: white;
          text-align: center;
          font-size: 18px;
          font-weight: bold;
        }
      
        .chatbox-body {
          padding: 15px;
          height: 220px;
          overflow-y: auto;
          background-color: #F9FAFB;
        }
      
        .chatbox-footer {
          display: flex;
          align-items: center;
          padding: 15px;
          background-color: #f1f1f1;
          border-top: 1px solid #ddd;
        }
      
        .chatbox-footer input {
          flex-grow: 1;
          padding: 10px;
          border-radius: 25px;
          border: 1px solid #ccc;
          outline: none;
        }
      
        .chatbox-footer button {
          background-color: #5A67D8;
          color: white;
          padding: 8px 15px;
          border: none;
          border-radius: 25px;
          margin-left: 10px;
          cursor: pointer;
        }
      
        .chatbox-footer button:hover {
          background-color: #434190;
        }
      
        .chatbox-body p {
          padding: 10px;
          border-radius: 15px;
          margin: 10px 0;
          max-width: 70%;
          word-wrap: break-word;
        }
      
        .chatbox-body p.user {
          background-color: #D6EAF8;
          color: #0000FF;
          text-align: right;
          margin-left: auto;
        }
      
        .chatbox-body p.bot {
          background-color: #E8EAF6;
          text-align: left;
          margin-right: auto;
        }

        .tjs__buttons__btn--info:hover {
          background-color: #b2b6fa;
          transform: scale(1.05);
        }

        /* Top-Center Flex Wrapper */
          .info-button-wrapper {
            position: fixed;
            top: 20px;
            width: 100%;
            display: flex;
            justify-content: center; /* Horizontally center */
            z-index: 1000;
          }

          .tjs__buttons__btn--info {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background-color: #3c4656; /* Dark slate color like in image */
            color: #ffffff;
            padding: 8px 16px;
            border: none;
            border-radius: 999px; /* Pill shape */
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s ease, transform 0.2s ease;
          }

          .tjs__buttons__btn--info:hover {
            background-color: #66b1d8; /* Light blue hover like your image */
            transform: scale(1.05);
          }

          .tjs__buttons__btn--info .icon {
            width: 16px;
            height: 16px;
            display: inline-block;
            opacity: 0.9;
          }
      </style>
      
</head>
<!-- üîê Re-auth-on-refresh, instead of redirecting immediately -->
<script>
  (function () {
    const token = localStorage.getItem('accessToken');

    // If first visit (no token), go to login
    if (!token) {
      window.location.href = 'index.html';
      return;
    }

    // Only show reauth on actual "reload"
    const navEntries = performance.getEntriesByType("navigation");
    const isReload = navEntries.length > 0 && navEntries[0].type === "reload";

    if (isReload) {
      // mark that we need reauth (used by the modal script below)
      sessionStorage.setItem('needsReauth', '1');
    } else {
      sessionStorage.removeItem('needsReauth');
      sessionStorage.removeItem('reauthAttempts');
    }
  })();
</script>



<script>
  function goToAdminDashboard() {
    window.location.href = 'admin.html';
  }
</script>

<!-- üîì Logout Button -->
<div style="position: fixed; top: 50px; right: 20px; z-index: 2000;">
  <button onclick="logout()" style="padding: 5px 20px; background-color: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer;">Logout</button>
</div>
<div style="position: fixed; top: 50px; right: 120px; z-index: 2000;" id="adminButtonContainer" hidden>
  <button onclick="goToAdminDashboard()" style="padding: 5px 20px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">Dashboard Approval</button>
</div>

<body>

    <!-- Main UI container for Terria -->
    <div id="ui"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


    <!-- Load CesiumJS -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.104/Build/Cesium/Cesium.js"></script>

    <!-- Load the main TerriaMap JavaScript -->
    <script src="build/TerriaMap.js"></script>

    <!-- Load the custom script for injecting 3D models -->
    <script src="https://cdn.jsdelivr.net/npm/mobx@6.9.0/dist/mobx.umd.production.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script> -->


    <div class="info-button-wrapper">
      <button class="tjs__buttons__btn--info" onclick="openGrafanaDashboard()">
        <img src="https://cdn-icons-png.flaticon.com/512/2041/2041637.png" alt="Data Icon" class="icon" />
        View Dashboard
      </button>
      <button class="tjs__buttons__btn--info" onclick="openBufferModal()">
        <img src="https://cdn-icons-png.flaticon.com/512/2041/2041637.png" alt="PAVE Icon" class="icon" />
        Run Process 
      </button>
    </div>

    <div id="bufferModal" class="modal" style="display:none; position:fixed; top:10%; left:10%; width:80%; height:80%; background:white; z-index:1000; border: 2px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.5);">
      <div style="padding:10px; text-align:right;">
        <button onclick="closeBufferModal()">Close</button>
      </div>
      <iframe id="bufferFrame" src="" style="width:100%; height:90%; border:none;"></iframe>
    </div>
  </div>
    
    
    <script>
      function openBufferModal() {
        const modal = document.getElementById('bufferModal');
        const frame = document.getElementById('bufferFrame');
        frame.src = "https://institute-seniors-priced-advisory.trycloudflare.com";
        modal.style.display = "block";
      }
    
      function closeBufferModal() {
        const modal = document.getElementById('bufferModal');
        const frame = document.getElementById('bufferFrame');
        frame.src = ""; // Clear iframe on close
        modal.style.display = "none";
      }
    </script>









<!-- üîí Re-auth Modal (shown only on refresh) -->
<style>
  .reauth-backdrop {
    position: fixed; inset: 0;
    background: rgba(0,0,0,.45);
    display: none; /* toggled by JS */
    z-index: 2147483000; /* above everything */
  }
  .reauth-wrap {
    position: fixed; inset: 0;
    display: flex; align-items: center; justify-content: center;
    pointer-events: none;
    z-index: 2147483001;
  }
  .reauth-card {
    width: 380px; max-width: 90vw;
    background: #fff; border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0,0,0,.35);
    padding: 22px;
    pointer-events: all;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  }
  .reauth-card h3 { margin: 0 0 10px; }
  .reauth-card p  { margin: 0 0 14px; color: #555; font-size: 14px; }
  .reauth-field { margin-bottom: 12px; }
  .reauth-field label { display: block; margin-bottom: 6px; font-size: 13px; color: #444; }
  .reauth-field input {
    width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;
  }
  .reauth-actions { display: flex; gap: 8px; margin-top: 8px; }
  .reauth-actions button {
    flex: 1; padding: 10px 12px; border: 0; border-radius: 8px; cursor: pointer; font-weight: 600;
  }
  .reauth-submit { background: linear-gradient(90deg,#667eea,#764ba2); color: #fff; }
  .reauth-cancel { background: #f1f1f1; color: #333; }
  .reauth-error { min-height: 18px; color: #e74c3c; font-size: 13px; margin-top: 6px; }
  body.reauth-lock { overflow: hidden; }
</style>

<div id="reauthBackdrop" class="reauth-backdrop"></div>
<div id="reauthWrap" class="reauth-wrap" style="display:none;">
  <div class="reauth-card">
    <h3>Confirm your identity</h3>
    <p>We detected a page refresh. Please re‚Äëenter your credentials to continue.</p>
    <div class="reauth-field">
      <label for="reauthEmail">Email</label>
      <input type="email" id="reauthEmail" autocomplete="email" />
    </div>
    <div class="reauth-field">
      <label for="reauthPassword">Password</label>
      <input type="password" id="reauthPassword" autocomplete="current-password" />
    </div>
    <div id="reauthError" class="reauth-error"></div>
    <div class="reauth-actions">
      <button id="reauthSubmit" class="reauth-submit">Continue</button>
      <button id="reauthCancel" class="reauth-cancel">Logout</button>
    </div>
  </div>
</div>

<script>
  // ========= Re-auth logic =========
  (function () {
    const needs = sessionStorage.getItem('needsReauth') === '1';
    if (!needs) return;

    const MAX_ATTEMPTS = 2;
    const wrap     = document.getElementById('reauthWrap');
    const backdrop = document.getElementById('reauthBackdrop');
    const emailEl  = document.getElementById('reauthEmail');
    const passEl   = document.getElementById('reauthPassword');
    const errEl    = document.getElementById('reauthError');
    const btnOK    = document.getElementById('reauthSubmit');
    const btnOut   = document.getElementById('reauthCancel');

      let allowRealUnload = false;

      function showModal(prefillOnly=false) {
    document.body.classList.add('reauth-lock');
    wrap.style.display = 'flex';
    backdrop.style.display = 'block';

    // Prefill email if you saved it at login
    const savedName = localStorage.getItem('userNameEmail');
    if (savedName && savedName.includes('@')) emailEl.value = savedName;

    if (!prefillOnly) setTimeout(() => (emailEl.value ? passEl.focus() : emailEl.focus()), 0);
  }

  function hideModal() {
    document.body.classList.remove('reauth-lock');
    wrap.style.display = 'none';
    backdrop.style.display = 'none';
    errEl.textContent = '';
    passEl.value = '';
  }

  function logoutAndRedirect() {
    localStorage.removeItem('accessToken');
    localStorage.removeItem('userName');
    localStorage.removeItem('isAdmin');
    window.location.href = 'index.html';
  }

  async function attemptReauth() {
    errEl.textContent = '';
    const email = (emailEl.value || '').trim();
    const password = passEl.value || '';
    if (!email || !password) {
      errEl.textContent = 'Please fill in both fields.';
      return;
    }

    try {
      const res = await fetch('http://localhost:3002/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data?.error || 'Invalid credentials');

      // update creds
      localStorage.setItem('accessToken', data.accessToken);
      localStorage.setItem('userName', data.name);
      localStorage.setItem('isAdmin', data.isAdmin);
      localStorage.setItem('userNameEmail', email);

      hideModal();

      // tiny toast
      setTimeout(() => {
        const t = document.createElement('div');
        t.textContent = 'Re-authenticated. Continuing without refresh.';
        Object.assign(t.style, {
          position: 'fixed', right: '16px', bottom: '16px',
          background: '#333', color: 'white', padding: '10px 14px',
          borderRadius: '8px', zIndex: 2147483646, boxShadow: '0 4px 12px rgba(0,0,0,.3)'
        });
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 2500);
      }, 150);
    } catch (e) {
      const cur = parseInt(sessionStorage.getItem('reauthAttempts') || '0', 10) + 1;
      sessionStorage.setItem('reauthAttempts', String(cur));
      if (cur >= MAX_ATTEMPTS) {
        errEl.textContent = 'Too many failed attempts. Logging out‚Ä¶';
        setTimeout(logoutAndRedirect, 800);
      } else {
        errEl.textContent = 'Invalid email or password. Try again.';
        passEl.select();
        passEl.focus();
      }
    }
  }

  btnOK.addEventListener('click', attemptReauth);
  btnOut.addEventListener('click', logoutAndRedirect);
  passEl.addEventListener('keydown', e => { if (e.key === 'Enter') attemptReauth(); });
  emailEl.addEventListener('keydown', e => { if (e.key === 'Enter') passEl.focus(); });

  /** ====== Intercept refresh/unload attempts ======
   *  - F5 / Ctrl+R / Cmd+R
   *  - any navigation that would unload (beforeunload)
   *  We cancel them and show the modal instead.
   */

  // 1) Keyboard refresh
  window.addEventListener('keydown', (e) => {
    const isReloadKey =
      e.key === 'F5' ||
      ((e.key === 'r' || e.key === 'R') && (e.ctrlKey || e.metaKey));

    if (isReloadKey) {
      e.preventDefault();
      e.stopPropagation();
      showModal();
    }
  }, { capture: true });

  // 2) Attempted unload (closing tab, navigating away, etc.)
  window.addEventListener('beforeunload', (e) => {
    if (allowRealUnload) return;   // not used in this flow; kept for future
    // If they have a token, we block and ask to re-auth instead of losing state
    if (localStorage.getItem('accessToken')) {
      e.preventDefault();
      e.returnValue = ''; // required for Chrome to show the native confirm
      // Immediately present your own modal too (most browsers still cancel if user stays)
      showModal();
      // Returning a string is ignored by modern browsers; the blank string is enough to trigger the dialog.
      return '';
    }
  });

  // 3) Optional: if a soft reauth is required on hard reload detection (from your earlier code),
  //    pre-open the modal once page loads:
  if (sessionStorage.getItem('needsReauth') === '1') {
    showModal(true);
    // clean up
    sessionStorage.removeItem('needsReauth');
    sessionStorage.removeItem('reauthAttempts');
  }
})();
</script>


















<script>
  async function openGrafanaDashboard() {
    // Use the Ngrok URL you get when running Ngrok
    const ngrokUrl = "https://invalid-un-composed-faster.trycloudflare.com"; // Replace with your actual Ngrok URL
    const dashboardPath = "/d/aefhk408ovk74e/cell-id-dashboard";

    window.open(`${ngrokUrl}${dashboardPath}`, "_blank");
  }
</script>

    <!-- Floating Avatar Button -->
<div class="floating-button" id="floatingButton">
    <img src="avatar.png" alt="Avatar" class="avatar">
</div>

<!-- Chatbox Modal -->
<div class="chatbox-modal" id="chatboxModal">
    <div class="chatbox-avatar">
        <img src="avatar.png" alt="Avatar">
    </div>
    <div class="chatbox-header">
      Chat with Ad
      <button id="refreshChat" style="float: right; background: none; border: none; color: white; font-size: 16px; cursor: pointer;">‚ü≥</button>
  </div>
  <!-- Guidelines Hover Button -->
<div class="guidelines-button" id="guidelinesButton">
  <img src="guide-icon.png" alt="Guidelines" class="avatar">
  <div class="guidelines-tooltip">
    <img src="guideline-preview.png" alt="Guideline Preview" />
  </div>
</div>

    <div class="chatbox-body">
        <p>Welcome! How can I help you today?</p>
        <div class="chatbox-buttons">
            <!-- <button data-intent="ask_downlink_user">Downlink User</button>
            <button data-intent="show_low_prb_utilization">PRB Utilization</button> -->
            <!-- <button data-intent="run_buffer_process">Run Buffer</button> -->
             <button data-intent="run_wedge_layers">Wedges</button>
            <button data-intent="run_nova_layers">Run NOVA</button>
             <button data-intent="run_atom_layers">Run ATOM</button> <!-- ‚úÖ New Button -->
        </div>
    </div>
    <div class="chatbox-footer">
        <input type="text" id="chatInput" placeholder="Type a message...">
        <button id="sendButton">Send</button>
    </div>
</div>

<script src="load3DModels.js"></script>
<script src="index.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
      const refreshButton = document.getElementById("refreshChat");
      const chatBody = document.querySelector(".chatbox-body");
      const chatInput = document.getElementById("chatInput");
      const sendButton = document.getElementById("sendButton");
      

      const rasaServerUrl = "http://localhost:5005/webhooks/rest/webhook"; // Update with your RASA server URL

function initializeButtons() {
  document.querySelectorAll(".chatbox-buttons button").forEach((button) => {
    button.addEventListener("click", function () {
      const intent = this.getAttribute("data-intent");

      // üîí RESERVED buttons: Don't send to Rasa
      if (intent === "run_nova_layers") {
        runNOVA();
        return;
      }
      if (intent === "run_atom_layers") {
        runATOM();
        return;
      }
      if (intent === "run_wedge_layers") {
        runWedges();
        return;
      }

      // üü¢ Other buttons are sent normally
      sendMessageToRasa(intent);
    });
  });
}

async function generatePDF(content) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({
    orientation: "portrait",
    unit: "mm",
    format: "a4"
  });

  // Use a clean, UTF-8-compatible font (no emoji, fallback only)
  doc.setFont("courier", "normal");
  doc.setFontSize(10);

  // Clean up emojis manually (optional fallback)
  const sanitized = content
    .replace(/üîç/g, "Summary:")
    .replace(/üôã‚Äç‚ôÇÔ∏è/g, "You:")
    .replace(/ü§ñ/g, "Bot:")
    .replace(/üìÇ/g, "Ticket:")
    .replace(/üìÅ/g, "Category:")
    .replace(/üìè/g, "Distance:");

  const lines = doc.splitTextToSize(sanitized, 180); // Wrap at 180mm
  doc.text(lines, 10, 20);

  doc.save("summary.pdf");
}


    function sendMessageToRasa(message) {
    function isValidCellID(input) {
        return /^[a-zA-Z0-9]+$/.test(input); // Matches alphanumeric only
    }

     const trivialInputs = ["yes", "chat", "pdf"];
    if (!trivialInputs.includes(message.toLowerCase())) {
        userMessages.push(message);
        userMessageCount++;
        messageHistory.push({ role: "user", text: message }); // ‚úÖ [NEW] Track user message
    }

    // Append user message to chat
    const userMessage = document.createElement("p");
    userMessage.classList.add("user");
    userMessage.textContent = message;
    chatBody.appendChild(userMessage);
    chatBody.scrollTop = chatBody.scrollHeight;

    // ‚è≥ Trigger summary prompt after 3 non-trivial user messages
    if (userMessageCount === 3 && !summaryPromptShown) {
        summaryPromptShown = true;
        setTimeout(() => {
            const botMessage = document.createElement("p");
            botMessage.classList.add("bot");
            botMessage.textContent = "You‚Äôve been active! Would you like a summary report?";
            chatBody.appendChild(botMessage);
            chatBody.scrollTop = chatBody.scrollHeight;

            messageHistory.push({ role: "bot", text: botMessage.textContent }); // ‚úÖ [NEW]
        }, 1000);
        return;
    }

    // Handle user's "yes" after summary prompt
    if (summaryPromptShown && message.toLowerCase() === "yes" && !waitingForSummaryChoice) {
        waitingForSummaryChoice = true;
        const botMessage = document.createElement("p");
        botMessage.classList.add("bot");
        botMessage.textContent = "Would you like the summary in the chat or as a downloadable PDF?";
        chatBody.appendChild(botMessage);
        chatBody.scrollTop = chatBody.scrollHeight;

        messageHistory.push({ role: "bot", text: botMessage.textContent }); // ‚úÖ [NEW]
        return;
    }

    // Handle user's summary preference
    if (waitingForSummaryChoice && ["chat", "pdf"].includes(message.toLowerCase())) {
let userIndex = 1;
let summaryText = "üîç Here's a summary of your conversation:\n\n";
let tempBlock = ""; // Collects one user + related bot replies
let currentUserIndex = 0;

messageHistory.forEach((entry, index) => {
    if (entry.role === "user") {
        // If there's an unfinished block, flush it with separator
        if (tempBlock.trim() !== "") {
            summaryText += tempBlock + "\n\n------------------------------\n\n";
            tempBlock = "";
        }

        currentUserIndex = userIndex++;
        tempBlock += `${currentUserIndex}. üôã‚Äç‚ôÇÔ∏è You:\n${entry.text}\n`;
    } else if (entry.role === "bot") {
        tempBlock += `\nü§ñ Bot:\n${entry.text}`;
    }

    // If it's the last entry, flush the block
    if (index === messageHistory.length - 1 && tempBlock.trim() !== "") {
        summaryText += tempBlock + "\n\n------------------------------\n\n";
    }
});



        if (message.toLowerCase() === "chat") {
            const botMessage = document.createElement("p");
            botMessage.classList.add("bot");
    botMessage.innerHTML = summaryText.replace(/\n/g, "<br>");
            chatBody.appendChild(botMessage);
            chatBody.scrollTop = chatBody.scrollHeight;
        } else {
            generatePDF(summaryText); // PDF version
        }

        waitingForSummaryChoice = false;
        return;
    }


// Check if the message is a CELL_ID prompt (e.g., "CELL_ID:1023C")
if (message.toLowerCase().startsWith("cell_id:")) {
    const CELL_ID = message.substring("cell_id:".length).trim();
    console.log(`üìç Recognized Cell ID for Grafana: ${CELL_ID}`);
    if (CELL_ID) {
        // Fly to the location on the map (if the function exists)
        if (typeof window.flyToSiteID === "function") {
            window.flyToSiteID(CELL_ID);
        } else {
            console.error("‚ùå flyToSiteID function is not available.");
        }

        const grafanaUrl = `https://invalid-un-composed-faster.trycloudflare.com/d/aefhk408ovk74e/cell-id-dashboard?orgId=1&var-cell_id=${encodeURIComponent(CELL_ID)}`;
        const newTab = window.open(grafanaUrl, '_blank'); // Opens in a new tab

        // Check if the new tab was blocked
        if (!newTab || newTab.closed || typeof newTab.closed === 'undefined') {
            alert("Popup blocked! Please allow popups for this site to open the Grafana dashboard.");
        }
    }
}
function isValidTicketID(input) {
    return (
        /^[0-9]{5}-[0-9]{4}$/i.test(input) ||   // your format: 07489-1950
        /^[a-z0-9]{4}-[a-z0-9]{4}$/i.test(input) || // 4-4 format
        /^[a-z0-9\-]{19,}$/i.test(input)           // long UUID-style
    );
}

    if (message.toLowerCase().includes("buffer")) {
    console.log("üì¶ Buffer process triggered via chatbot.");

    // Open the buffer modal
    openBufferModal(); // This already exists in your HTML
}
// üÜï Check for "Run NOVA" intent
if (message.toLowerCase().includes("nova")) {
    console.log("üöÄ Run NOVA triggered via chatbot.");
    runNOVA();
}
if (message.toLowerCase().includes("atom")) {
    console.log("‚öõÔ∏è Run ATOM triggered via chatbot.");
    runATOM();
}
if (message.toLowerCase().includes("wedge")) {
    console.log("üîª Run WEDGES triggered via chatbot.");
    runWedges();
}



    // üÜï Check if it's a Ticket ID
    if (isValidTicketID(message)) {
    const TICKET_ID = message.trim();
    console.log(`üéüÔ∏è Recognized Ticket ID: ${TICKET_ID}`);

    // ‚úÖ First try your new dataset
    if (typeof window.flyToNetworkComplain2 === "function") {
        window.flyToNetworkComplain2(TICKET_ID);
    }

    // ‚úÖ Then fallback to old one
    else if (typeof window.flyToTicketLocation === "function") {
        window.flyToTicketLocation(TICKET_ID);
    } else {
        console.error("‚ùå No fly-to function available for Ticket ID.");
    }
}

    // ‚úÖ Check if it's a Site ID (CELL_ID)
    else if (isValidCellID(message)) {
        const CELL_ID = message.trim();
        console.log(`üìç Recognized Cell ID: ${CELL_ID}`);
        if (typeof window.flyToSiteID === "function") {
            window.flyToSiteID(CELL_ID);
        } else {
            console.error("‚ùå flyToSiteID function is not available.");
        }
const grafanaUrl = `https://invalid-un-composed-faster.trycloudflare.com/d/aefhk408ovk74e/cell-id-dashboard?orgId=1&var-cell_id=${encodeURIComponent(CELL_ID)}`;
const newTab = window.open(grafanaUrl, '_blank');
if (!newTab || newTab.closed || typeof newTab.closed === 'undefined') {
    alert("Popup blocked! Please allow popups for this site.");
}

    }

    // Always send to Rasa server
       fetch(rasaServerUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        data.forEach(response => {
            const botMessage = document.createElement("p");
            botMessage.classList.add("bot");
            botMessage.textContent = response.text;
            chatBody.appendChild(botMessage);
            chatBody.scrollTop = chatBody.scrollHeight;

            messageHistory.push({ role: "bot", text: response.text }); // ‚úÖ [NEW] Track bot reply
        });
    })
    .catch(error => {
        console.error("Error sending message:", error);
        const errorMessage = document.createElement("p");
        errorMessage.classList.add("bot");
        errorMessage.textContent = "Sorry, an error occurred. Please try again.";
        chatBody.appendChild(errorMessage);

        messageHistory.push({ role: "bot", text: errorMessage.textContent }); // ‚úÖ [NEW]
    });
}
function runATOM() {
    console.log("‚öõÔ∏è Run ATOM button clicked");

    const atomLayerIds = [
        "ATOM DB SCAN CLUSTERS",
        "ATOM Polygon",
        "ATOM DB Cleaned",
        "ATOM MR Grid",
        "ATOM Population Clusters"
    ];

    const catalogModels = window.terria.catalog.group.memberModels;

    atomLayerIds.forEach(layerName => {
        const layerModel = findLayerByNameRecursive(catalogModels, layerName);

        if (layerModel) {
            window.terria.workbench.add(layerModel);
            console.log(`‚úÖ Enabled ATOM layer: ${layerName}`);
        } else {
            console.warn(`‚ö†Ô∏è ATOM layer not found: ${layerName}`);
        }
    });
}
function runWedges() {
    console.log("üß≠ Loading Wedge layers...");

    const wedgeLayerIds = [
        "Wedge L900",
        "Wedge L1800",
        "Wedge L2100",
        "Wedge L2600"
    ];

    const catalogModels = window.terria.catalog.group.memberModels;

    wedgeLayerIds.forEach(layerName => {
        const layerModel = findLayerByNameRecursive(catalogModels, layerName);

        if (layerModel) {
            window.terria.workbench.add(layerModel);
            console.log(`‚úÖ Loaded: ${layerName}`);
        } else {
            console.warn(`‚ö†Ô∏è Not found: ${layerName}`);
        }
    });
}

function runNOVA() {
    console.log("üöÄ Run NOVA button clicked");

    const novaLayerIds = [
      "NOVA Nominal Point",
        "NOVA Buffer",
        "NOVA Result",
        "Delaunay Triangulation"
    ];

    // üîç Search from full catalog
    const catalogModels = window.terria.catalog.group.memberModels;

    novaLayerIds.forEach(layerName => {
        const layerModel = findLayerByNameRecursive(catalogModels, layerName);

        if (layerModel) {
            window.terria.workbench.add(layerModel);
            console.log(`‚úÖ Enabled layer: ${layerName}`);
        } else {
            console.warn(`‚ö†Ô∏è Layer not found: ${layerName}`);
        }
    });
}

// üîç Recursive layer search
function findLayerByNameRecursive(models, name) {
    for (const item of models) {
        if (item.name === name) {
            return item;
        }
        if (item.memberModels && item.memberModels.length > 0) {
            const found = findLayerByNameRecursive(item.memberModels, name);
            if (found) return found;
        }
    }
    return null;
}
let userMessageCount = 0;
let userMessages = [];
let messageHistory = []; // ‚úÖ [NEW] Stores full conversation (user + bot)
let summaryPromptShown = false;
let waitingForSummaryChoice = false;

      sendButton.addEventListener("click", function () {
          const message = chatInput.value.trim();
          if (message !== "") {
              sendMessageToRasa(message);
              chatInput.value = ""; // Clear input field after sending
          }
      });

      refreshButton.addEventListener("click", function () {
          chatBody.innerHTML = `
              <p>Welcome! How can I help you today?</p>
              <div class="chatbox-buttons">
                  // <button data-intent="ask_downlink_user">Downlink User</button>
                  // <button data-intent="show_low_prb_utilization">PRB Utilization</button>
                  // <button data-intent="run_buffer_process">Run Buffer</button>
                  <button data-intent="run_nova_layers">Run NOVA</button>
                  <button data-intent="run_wedge_layers">Wedges</button>


              </div>
          `;
          chatInput.value = ""; // Clears the input field
          initializeButtons(); // Rebind event listeners after reset
      });

      initializeButtons(); // Ensure buttons work on page load
  });

  document.addEventListener("DOMContentLoaded", function () {
      console.log("üîç Searching for Terria logo...");

      setTimeout(() => {
          const terriaLogo = document.querySelector(".TerriaLogo___StyledImg-sc-bk2yek-0");
          if (terriaLogo) {
              terriaLogo.remove();
              console.log("‚ùå Removed Terria logo.");
          } else {
              console.warn("‚ö†Ô∏è Terria logo not found.");
          }
      }, 1000);
      
  });

</script>
  
<script>
  function logout() {
    localStorage.removeItem('accessToken');
    localStorage.removeItem('userName');
    localStorage.removeItem('isAdmin');
    window.location.href = 'index.html';
  }
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const isAdmin = localStorage.getItem('isAdmin');
    const adminButton = document.getElementById('adminButtonContainer');

    if (isAdmin === 'true') {
      adminButton.hidden = false; // Show the "Dashboard Approval" button
    }
  });

</script>
<!-- START FOR GRAPH -->
<!-- Toggle Button -->
<button 
  id="toggleGraphsBtn" 
  style="position: fixed; top: 58px; right: 320px; z-index: 2100; padding: 6px 10px; border-radius: 6px; border: none; background: #1976d2; color: white; cursor: pointer; font-size: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">
  üìä Show Graphs
</button>

<!-- Graphs Side Panel -->
<div id="graphsContainer">
  <div class="graph-header">
    <span>üìä Network Graphs</span>
    <button id="closeGraphsBtn">√ó</button>
  </div>

  <!-- RSRP -->
  <div class="graph-block">
    <div class="graph-title">RSRP Distribution</div>
    <iframe id="rsrpFrame" src="http://localhost:9090/superset/explore/p/ZeN2vyjwo0l/?standalone=1&height=400"></iframe>
  </div>

  <!-- Download -->
  <div class="graph-block">
    <div class="graph-title">Download Distribution</div>
    <iframe id="downloadFrame" src="http://localhost:9090/superset/explore/p/Y1DrRGjwJ6n/?standalone=1&height=400"></iframe>
  </div>

  <!-- Upload -->
  <div class="graph-block">
    <div class="graph-title">Upload Distribution</div>
    <iframe id="uploadFrame" src="http://localhost:9090/superset/explore/p/BlePR6rRGzj/?standalone=1&height=400"></iframe>
  </div>

  <!-- Sites + Complaints side by side -->
<div class="graph-row">
  <!-- Num of Sites -->
  <div class="graph-blocks">
    <div class="graph-title">Number of Sites</div>
    <iframe id="sitesFrame" src="http://localhost:9090/superset/explore/p/xpMVvn6v4jg/?standalone=1&height=400"></iframe>
  </div>

  <!-- Num of Complaints -->
  <div class="graph-blocks">
    <div class="graph-title">Number of Complaints</div>
    <iframe id="complaintsFrame" src="http://localhost:9090/superset/explore/p/3pMDRqYRgJN/?standalone=1&height=400">></iframe>
  </div>
</div>


<style>
/* Side panel container */
#graphsContainer {
  position: fixed;
  top: 0;
  left: -350px; /* hidden by default */
  width: 320px;
  height: 100%;
  background: #fff;
  border-left: 2px solid #ddd;
  box-shadow: -2px 0 6px rgba(0,0,0,0.2);
  transition: right 0.3s ease;
  z-index: 2000;
  display: flex;
  flex-direction: column;
  padding: 10px;
  font-size: 12px;
  font-family: sans-serif;
}

#graphsContainer.open {
  left: 0; /* slides in */
}

/* Header */
.graph-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: bold;
  padding-bottom: 8px;
  border-bottom: 1px solid #ccc;
}

#closeGraphsBtn {
  border: none;
  background: transparent;
  font-size: 18px;
  cursor: pointer;
}

/* Each block */
.graph-block {
  margin-top: 10px;
}

.graph-title {
  font-weight: bold;
  margin-bottom: 4px;
  text-align: center;
}

/* Consistent iframes */
.graph-block iframe {
  width: 100%;
  height: 130px;
  border-radius: 8px;
  border: none;
}

/*for site and complaint*/
.graph-blocks iframe {
  width: 100%;
  height: 120px;
  border-radius: 8px;
  border: none;
}
/* Row container for graphs */
.graph-row {
  display: flex;
  gap: 15px;          /* space between the two blocks */
}

/* Make both blocks share equal width */
.graph-row .graph-block {
  flex: 1;
}

/* Hide toggle button when workbench or graph is open */
.hide-toggle {
  display: none !important;
}

</style>

<script>
/* Toggle button logic */
document.getElementById("toggleGraphsBtn").addEventListener("click", function() {
  const container = document.getElementById("graphsContainer");
  container.classList.toggle("open");

  if (container.classList.contains("open")) {
    this.classList.add("hide-toggle"); // hide button when panel is open
  } else {
    this.innerText = "üìä Show Graphs";
  }
});

/* Close button inside panel */
document.getElementById("closeGraphsBtn").addEventListener("click", function() {
  const toggleBtn = document.getElementById("toggleGraphsBtn");
  document.getElementById("graphsContainer").classList.remove("open");
  toggleBtn.innerText = "üìä Show Graphs";
  toggleBtn.classList.remove("hide-toggle"); // show again when closed
});

/* Refresh Superset iframes */
function refreshSupersetIframe() {
  ["rsrpFrame", "downloadFrame", "uploadFrame", "sitesFrame", "complaintsFrame"].forEach(id => {
    const iframe = document.getElementById(id);
    if (iframe) {
      iframe.src = iframe.src.split("&r=")[0] + "&r=" + Date.now();
    }
  });
}

/* Send viewport to backend */
function postViewport(minLat, maxLat, minLng, maxLng) {
  return fetch("http://localhost:3002/api/viewport/update", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      user_id: "1",
      min_lat: minLat,
      max_lat: maxLat,
      min_lon: minLng,
      max_lon: maxLng
    })
  });
}

function sendViewportToBackend() {
  const scene = window.terria?.cesium?.scene;
  if (!scene || !scene.camera) return;
  const rect = scene.camera.computeViewRectangle();
  if (!rect) return;

  const minLng = Cesium.Math.toDegrees(rect.west);
  const maxLng = Cesium.Math.toDegrees(rect.east);
  const minLat = Cesium.Math.toDegrees(rect.south);
  const maxLat = Cesium.Math.toDegrees(rect.north);

  postViewport(minLat, maxLat, minLng, maxLng)
    .then(() => refreshSupersetIframe())
    .catch(err => console.error("Failed to update viewport:", err));
}

/* Debounce so we don‚Äôt hammer backend */
function debounce(fn, ms) {
  let t;
  return function () {
    clearTimeout(t);
    t = setTimeout(() => fn.apply(this, arguments), ms);
  };
}
const debouncedSend = debounce(sendViewportToBackend, 300);

/* Attach viewport listener */
function attachViewportUpdater() {
  const scene = window.terria?.cesium?.scene;
  if (scene && scene.camera) {
    scene.camera.moveEnd.addEventListener(debouncedSend);
    // Send once at startup
    setTimeout(sendViewportToBackend, 500);
    console.log("Viewport updater attached!");
  } else {
    setTimeout(attachViewportUpdater, 500);
  }
}

function observeWorkbench() {
  const workbench = document.querySelector(".tjs-workbench"); // adjust selector
  if (!workbench) return;

  const toggleBtn = document.getElementById("toggleGraphsBtn");
  const observer = new MutationObserver(() => {
    if (workbench.classList.contains("is-open")) {  
      toggleBtn.classList.add("hide-toggle");
    } else {
      toggleBtn.classList.remove("hide-toggle");
    }
  });

  observer.observe(workbench, { attributes: true, attributeFilter: ["class"] });
}

observeWorkbench();
attachViewportUpdater();
</script>

</body>
</html>